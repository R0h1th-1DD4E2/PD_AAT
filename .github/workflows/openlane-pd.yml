name: OpenLane Physical Design Flow

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DESIGN_NAME: posit_mul
  # OpenLane v1 container from The-OpenROAD-Project
  OPENLANE_IMAGE: ghcr.io/the-openroad-project/openlane
  # Pin to a known tag/sha for reproducibility; you can change this later
  OPENLANE_TAG: ff5509f65b17bfa4068d5336495ab1718987ff69
  RUN_BASE: openlane_runs
  RUN_TAG: github_ci

jobs:
  physical-design:
    name: Run OpenLane PD Flow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker info
        run: |
          docker --version
          echo "Docker is available."

      - name: Pull OpenLane Docker Image
        run: |
          docker pull "${OPENLANE_IMAGE}:${OPENLANE_TAG}"

      - name: Prepare OpenLane design directory
        run: |
          # Create a design directory layout that OpenLane likes:
          #   openlane_work/
          #     config.tcl
          #     src/   (your RTL)
          #     sdc/   (your constraints)
          mkdir -p openlane_work

          cp -r src openlane_work/
          cp -r sdc openlane_work/
          cp config/config.tcl openlane_work/config.tcl

          echo "OpenLane design directory structure:"
          tree openlane_work || ls -R openlane_work

      - name: Run OpenLane Flow (inside container)
        id: openlane_run
        continue-on-error: true
        run: |
          RUN_BASE="${RUN_BASE}"
          RUN_TAG="${RUN_TAG}"

          # All outputs will land under: $PWD/${RUN_BASE}/${RUN_TAG}
          mkdir -p "${RUN_BASE}"

          echo "Launching OpenLane container..."
          docker run --rm \
            -v "$PWD":/project \
            -w /openlane \
            "${OPENLANE_IMAGE}:${OPENLANE_TAG}" \
            bash -lc "
              set -e
              echo \"Using design at /project/openlane_work\"
              echo \"Run base: /project/${RUN_BASE}, tag: ${RUN_TAG}\"
              ./flow.tcl -overwrite \
                -design /project/openlane_work \
                -run_path /project/${RUN_BASE} \
                -tag ${RUN_TAG}
            "

          EXIT_CODE=$?
          echo "OpenLane flow exit code: ${EXIT_CODE}"
          exit "${EXIT_CODE}"

      - name: Expose run directory path
        id: run_dir
        if: always()
        run: |
          RUN_DIR="${RUN_BASE}/${RUN_TAG}"
          if [ -d "${RUN_DIR}" ]; then
            echo "Run directory found: ${RUN_DIR}"
            echo "run_found=true" >> "$GITHUB_OUTPUT"
            echo "run_path=${RUN_DIR}" >> "$GITHUB_OUTPUT"
            ls -la "${RUN_DIR}" || true
          else
            echo "Run directory NOT found at ${RUN_DIR}"
            echo "run_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate PD Summary
        if: always()
        run: |
          REPORT_FILE="PD_SUMMARY.md"
          echo "# üìä Physical Design Flow Summary" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Design:** ${DESIGN_NAME}" >> "$REPORT_FILE"
          echo "**Date:** $(date -u)" >> "$REPORT_FILE"
          echo "**Commit:** ${{ github.sha }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          if [ "${{ steps.run_dir.outputs.run_found }}" != "true" ]; then
            echo "## ‚ö†Ô∏è Error" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "Run directory not found. The OpenLane flow may have failed to start." >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            cat "$REPORT_FILE"
            exit 0
          fi

          RUN_PATH="${{ steps.run_dir.outputs.run_path }}"
          REPORTS_DIR="${RUN_PATH}/reports"
          RESULTS_DIR="${RUN_PATH}/results"

          echo "Using RUN_PATH=${RUN_PATH}" 

          # List some key files
          echo "## üîç Run Directory Contents" >> "$REPORT_FILE"
          echo '```' >> "$REPORT_FILE"
          find "$RUN_PATH" -type f \( -name "*.rpt" -o -name "*.log" \) 2>/dev/null | head -40 >> "$REPORT_FILE" || true
          echo '```' >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Timing report
          echo "## ‚è±Ô∏è Timing Analysis" >> "$REPORT_FILE"
          TIMING_RPT=$(find "$RUN_PATH" -type f \( -name "*timing*.rpt" -o -name "sta*.rpt" -o -name "signoff*.rpt" \) 2>/dev/null | head -1)
          if [ -f "$TIMING_RPT" ]; then
            echo "" >> "$REPORT_FILE"
            echo "_Showing first 50 lines of timing report: \`$(basename "$TIMING_RPT")\`_" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            head -50 "$TIMING_RPT" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
          else
            echo "‚ö†Ô∏è Timing report not found" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # Area report
          echo "## üìê Area Report" >> "$REPORT_FILE"
          AREA_RPT=$(find "$RUN_PATH" -type f \( -name "*area*.rpt" -o -name "*synthesis*.rpt" \) 2>/dev/null | head -1)
          if [ -f "$AREA_RPT" ]; then
            echo "" >> "$REPORT_FILE"
            echo "_Showing first 50 lines of area/synthesis report: \`$(basename "$AREA_RPT")\`_" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            head -50 "$AREA_RPT" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
          else
            echo "‚ö†Ô∏è Area report not found" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # Power report
          echo "## ‚ö° Power Analysis" >> "$REPORT_FILE"
          POWER_RPT=$(find "$RUN_PATH" -type f -name "*power*.rpt" 2>/dev/null | head -1)
          if [ -f "$POWER_RPT" ]; then
            echo "" >> "$REPORT_FILE"
            echo "_Showing first 50 lines of power report: \`$(basename "$POWER_RPT")\`_" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            head -50 "$POWER_RPT" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
          else
            echo "‚ö†Ô∏è Power report not found" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # DRC report
          echo "## üî¨ DRC Violations" >> "$REPORT_FILE"
          DRC_RPT=$(find "$RUN_PATH" -type f \( -name "*drc*.rpt" -o -name "*violations*.rpt" \) 2>/dev/null | head -1)
          if [ -f "$DRC_RPT" ]; then
            echo "" >> "$REPORT_FILE"
            echo "_Showing first 50 lines of DRC report: \`$(basename "$DRC_RPT")\`_" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            head -50 "$DRC_RPT" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
          else
            echo "‚úÖ No DRC report found (may indicate a clean run, or DRC not executed)" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          cat "$REPORT_FILE"

      - name: Find GDS File
        if: always()
        id: find_gds
        run: |
          if [ "${{ steps.run_dir.outputs.run_found }}" != "true" ]; then
            echo "gds_found=false" >> "$GITHUB_OUTPUT"
            echo "No run directory, skipping GDS search."
            exit 0
          fi

          RUN_PATH="${{ steps.run_dir.outputs.run_path }}"

          GDS_FILE=$(find "$RUN_PATH" -type f \( -name "*.gds" -o -name "*.gds.gz" \) 2>/dev/null | head -1)

          if [ -n "$GDS_FILE" ]; then
            echo "GDS file found: $GDS_FILE"
            echo "gds_found=true" >> "$GITHUB_OUTPUT"
            echo "gds_path=$GDS_FILE" >> "$GITHUB_OUTPUT"

            if [[ "$GDS_FILE" == *.gz ]]; then
              GDS_HASH=$(gunzip -c "$GDS_FILE" | sha256sum | cut -d' ' -f1)
            else
              GDS_HASH=$(sha256sum "$GDS_FILE" | cut -d' ' -f1)
            fi

            echo "gds_hash=$GDS_HASH" >> "$GITHUB_OUTPUT"
            echo "GDS hash: $GDS_HASH"
          else
            echo "‚ö†Ô∏è No GDS file found."
            echo "gds_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Append 3D GDS Viewer Link
        if: always() && steps.find_gds.outputs.gds_found == 'true'
        run: |
          echo "" >> PD_SUMMARY.md
          echo "## üé® 3D GDS Viewer" >> PD_SUMMARY.md
          echo "" >> PD_SUMMARY.md
          echo "View your design in 3D using TinyTapeout's GDS viewer:" >> PD_SUMMARY.md
          echo "" >> PD_SUMMARY.md

          # Note: this assumes you later upload ${DESIGN_NAME}.gds as a release asset (see 'Create Release' step).
          VIEWER_URL="https://gds-viewer.tinytapeout.com/?model=https://github.com/${{ github.repository }}/releases/download/latest/${{ env.DESIGN_NAME }}.gds"
          echo "üîó [Open 3D Viewer](${VIEWER_URL})" >> PD_SUMMARY.md
          echo "" >> PD_SUMMARY.md
          echo "_Note: For the 3D viewer to work, the GDS file must be publicly accessible as a release asset._" >> PD_SUMMARY.md
          echo "" >> PD_SUMMARY.md

          cat PD_SUMMARY.md

      - name: Collect All PD Artifacts
        if: always()
        run: |
          mkdir -p artifacts/reports artifacts/results artifacts/logs

          if [ "${{ steps.run_dir.outputs.run_found }}" = "true" ]; then
            RUN_PATH="${{ steps.run_dir.outputs.run_path }}"

            # Reports
            find "$RUN_PATH" -type f -name "*.rpt" -exec cp {} artifacts/reports/ \; 2>/dev/null || true

            # Key result files (DEF/LEF/netlist/SDF/SPEF/GDS)
            find "$RUN_PATH" -type f -name "*.def"  -exec cp {} artifacts/results/ \; 2>/dev/null || true
            find "$RUN_PATH" -type f -name "*.lef"  -exec cp {} artifacts/results/ \; 2>/dev/null || true
            find "$RUN_PATH" -type f -name "*.v"    -exec cp {} artifacts/results/ \; 2>/dev/null || true
            find "$RUN_PATH" -type f -name "*.sdf"  -exec cp {} artifacts/results/ \; 2>/dev/null || true
            find "$RUN_PATH" -type f -name "*.spef" -exec cp {} artifacts/results/ \; 2>/dev/null || true

            if [ "${{ steps.find_gds.outputs.gds_found }}" = "true" ]; then
              cp "${{ steps.find_gds.outputs.gds_path }}" artifacts/results/
            fi

            # Logs
            find "$RUN_PATH" -type f -name "*.log" -exec cp {} artifacts/logs/ \; 2>/dev/null || true
          fi

          # Summary
          cp PD_SUMMARY.md artifacts/ 2>/dev/null || true

          echo "Artifacts collected:"
          ls -R artifacts/ || echo "No artifacts found"

      - name: Upload PD Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openlane-pd-reports
          path: artifacts/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload PD Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openlane-pd-results
          path: artifacts/results/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload PD Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openlane-pd-logs
          path: artifacts/logs/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload PD Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openlane-pd-summary
          path: PD_SUMMARY.md
          retention-days: 30
          if-no-files-found: warn

      - name: Upload GDS File
        if: always() && steps.find_gds.outputs.gds_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: openlane-gds-file
          path: ${{ steps.find_gds.outputs.gds_path }}
          retention-days: 90

      - name: Comment PR with Summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('PD_SUMMARY.md', 'utf8');
            } catch (error) {
              summary = '‚ö†Ô∏è Physical Design flow encountered issues. Check the logs for details.';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary,
            });

      - name: Create Release with GDS (on tag)
        if: startsWith(github.ref, 'refs/tags/') && steps.find_gds.outputs.gds_found == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.find_gds.outputs.gds_path }}
            artifacts/reports/*
            PD_SUMMARY.md
          body: |
            ## Physical Design Release

            This release contains the GDSII file and reports from the OpenLane PD flow.

            View in 3D: https://gds-viewer.tinytapeout.com/?model=https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.DESIGN_NAME }}.gds
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final Status
        if: always()
        run: |
          echo "======================================"
          echo "OpenLane Physical Design Flow Complete"
          echo "======================================"
          echo "  üìä Timing, Area, Power reports"
          echo "  üìê DEF, LEF, netlist, SDF, SPEF"
          echo "  üé® GDS file (if generated)"
          echo "  üìù Complete logs"
          echo "======================================"

          if [ "${{ steps.openlane_run.outcome }}" = "success" ]; then
            echo "‚úÖ OpenLane flow completed successfully!"
            exit 0
          else
            echo "‚ö†Ô∏è OpenLane flow had issues - check artifacts/logs"
            exit 1
          fi
